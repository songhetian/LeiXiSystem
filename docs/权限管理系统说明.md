# 权限管理系统说明文档

## 📋 目录

1. [系统概述](#系统概述)
2. [快速开始](#快速开始)
3. [核心概念](#核心概念)
4. [系统角色](#系统角色)
5. [权限列表](#权限列表)
6. [API接口](#api接口)
7. [使用指南](#使用指南)
8. [最佳实践](#最佳实践)

---

## 系统概述

雷犀客服系统采用 **RBAC（基于角色的访问控制）** 权限管理模型，实现了灵活、安全的权限控制机制。

### 核心特性

- ✅ **角色管理**：支持自定义角色，灵活配置权限
- ✅ **权限分配**：细粒度的权限控制，精确到操作级别
- ✅ **用户角色**：一个用户可以拥有多个角色
- ✅ **角色继承**：通过角色级别实现权限继承
- ✅ **系统角色**：内置8个系统角色，不可删除
- ✅ **权限检查**：前后端双重权限验证

### 数据库表结构

```
roles (角色表)
├── id: 角色ID
├── name: 角色名称
├── description: 角色描述
├── level: 角色级别（1-10）
└── is_system: 是否系统角色

permissions (权限表)
├── id: 权限ID
├── name: 权限名称
├── code: 权限代码
├── resource: 资源名称
├── action: 操作类型
├── description: 权限描述
└── module: 所属模块

user_roles (用户角色关联表)
├── user_id: 用户ID
├── role_id: 角色ID
└── assigned_at: 分配时间

role_permissions (角色权限关联表)
├── role_id: 角色ID
└── permission_id: 权限ID
```

---

## 快速开始

### 1. 安装权限管理系统

在 `customer-service-desktop/database` 目录下运行：

```bash
# Windows
install-permissions.bat

# 或手动执行SQL
mysql -u root -p leixin_customer_service < permissions-system.sql
```

### 2. 验证安装

登录系统后，访问 **系统管理 > 权限管理** 页面，应该能看到：

- 8个系统角色
- 60+个权限项
- 用户角色分配功能

### 3. 为用户分配角色

1. 进入 **权限管理** 页面
2. 切换到 **用户角色** 标签
3. 点击用户的 **管理角色** 按钮
4. 勾选要分配的角色
5. 保存即可

---

## 核心概念

### RBAC模型

```
用户 (User) ←→ 角色 (Role) ←→ 权限 (Permission)
```

- **用户**：系统的使用者
- **角色**：一组权限的集合
- **权限**：对资源的操作许可

### 权限代码格式

```
资源:操作
例如：
- user:list      (查看用户列表)
- user:create    (创建用户)
- employee:update (编辑员工)
```

### 角色级别

- **级别范围**：1-10
- **级别越高**：权限越大
- **用途**：用于权限继承和层级管理

---

## 系统角色

### 1. 超级管理员 (Level 10)

**权限范围**：所有权限

**适用人员**：系统最高管理者

**主要职责**：
- 系统配置和维护
- 用户和权限管理
- 数据备份和恢复

### 2. 系统管理员 (Level 9)

**权限范围**：除系统备份/恢复外的所有权限

**适用人员**：IT管理员

**主要职责**：
- 用户管理
- 角色权限配置
- 系统日常维护

### 3. 部门经理 (Level 7)

**权限范围**：部门、员工、考勤、请假、排班管理

**适用人员**：各部门负责人

**主要职责**：
- 管理本部门员工
- 审批请假申请
- 安排员工排班
- 查看部门数据

### 4. 客服主管 (Level 6)

**权限范围**：员工、质检、考核、案例、考勤管理

**适用人员**：客服团队负责人

**主要职责**：
- 管理客服团队
- 质检审核
- 绩效考核
- 知识库管理

### 5. 培训师 (Level 5)

**权限范围**：考核、案例管理

**适用人员**：培训部门人员

**主要职责**：
- 创建培训内容
- 组织考试考核
- 管理知识案例

### 6. 质检员 (Level 4)

**权限范围**：质检、案例管理

**适用人员**：质检部门人员

**主要职责**：
- 执行会话质检
- 评分和反馈
- 整理优秀案例

### 7. 客服专员 (Level 3)

**权限范围**：基础客服功能

**适用人员**：一线客服人员

**主要职责**：
- 处理客户咨询
- 查看知识库
- 考勤打卡
- 订餐请假

### 8. 普通员工 (Level 1)

**权限范围**：最基础权限

**适用人员**：其他部门员工

**主要职责**：
- 考勤打卡
- 请假申请
- 订餐
- 查看消息

---

## 权限列表

### 用户管理模块

| 权限代码 | 权限名称 | 说明 |
|---------|---------|------|
| user:list | 查看用户列表 | 查看系统所有用户 |
| user:create | 创建用户 | 创建新用户账号 |
| user:update | 编辑用户 | 编辑用户基本信息 |
| user:delete | 删除用户 | 删除用户账号 |
| user:reset_password | 重置密码 | 重置用户登录密码 |
| user:detail | 查看用户详情 | 查看用户详细信息 |

### 角色管理模块

| 权限代码 | 权限名称 | 说明 |
|---------|---------|------|
| role:list | 查看角色列表 | 查看系统所有角色 |
| role:create | 创建角色 | 创建新角色 |
| role:update | 编辑角色 | 编辑角色信息 |
| role:delete | 删除角色 | 删除角色 |
| role:assign_permission | 分配权限 | 为角色分配权限 |
| user:assign_role | 分配角色 | 为用户分配角色 |

### 部门管理模块

| 权限代码 | 权限名称 | 说明 |
|---------|---------|------|
| department:list | 查看部门列表 | 查看所有部门信息 |
| dreate | 创建部门 | 创建新部门 |
| department:update | 编辑部门 | 编辑部门信息 |
| department:delete | 删除部门 | 删除部门 |

### 员工管理模块

| 权限代码 | 权限名称 | 说明 |
|---------|---------|------|
| employee:list | 查看员工列表 | 查看所有员工信息 |
| employee:create | 创建员工 | 添加新员工 |
| employee:update | 编辑员工 | 编辑员工信息 |
| employee:delete | 删除员工 | 删除员工记录 |
| employee:detail | 查看员工详情 | 查看员工详细信息 |
| employee:changes | 查看员工变动 | 查看员工变动记录 |

### 考勤管理模块

| 权限代码 | 权限名称 | 说明 |
|---------|---------|------|
| attendance:list | 查看考勤记录 | 查看考勤打卡记录 |
| attendance:checkin | 打卡签到 | 员工打卡签到 |
| attendance:checkout | 打卡签退 | 员工打卡签退 |
| attendance:statistics | 考勤统计 | 查看考勤统计报表 |
| attendance:update | 修改考勤 | 修改考勤记录 |

### 排班管理模块

| 权限代码 | 权限名称 | 说明 |
|---------|---------|------|
| schedule:list | 查看排班表 | 查看员工排班安排 |
| schedule:create | 创建排班 | 创建排班计划 |
| schedule:update | 编辑排班 | 修改排班安排 |
| schedule:delete | 删除排班 | 删除排班记录 |

### 请假管理模块

| 权限代码 | 权限名称 | 说明 |
|---------|---------|------|
| leave:list | 查看请假记录 | 查看请假申请记录 |
| leave:create | 申请请假 | 提交请假申请 |
| leave:approve | 审批请假 | 审批请假申请 |
| leave:cancel | 取消请假 | 取消请假申请 |

### 质检管理模块

| 权限代码 | 权限名称 | 说明 |
|---------|---------|------|
| quality:list | 查看质检列表 | 查看质检会话列表 |
| quality:create | 创建质检 | 创建质检任务 |
| quality:inspect | 执行质检 | 进行质检评分 |
| quality:detail | 查看质检详情 | 查看质检详细信息 |
| quality:statistics | 质检统计 | 查看质检统计报表 |

### 考核管理模块

| 权限代码 | 权限名称 | 说明 |
|---------|---------|------|
| assessment:list | 查看考核列表 | 查看考核计划列表 |
| assessment:create | 创建考核 | 创建考核计划 |
| assessment:update | 编辑考核 | 编辑考核计划 |
| assessment:delete | 删除考核 | 删除考核计划 |
| assessment:take | 参加考试 | 参加考核考试 |
| assessment:result | 查看成绩 | 查看考核成绩 |

### 案例管理模块

| 权限代码 | 权限名称 | 说明 |
|---------|---------|------|
| case:list | 查看案例库 | 查看知识案例库 |
| case:create | 创建案例 | 创建新案例 |
| case:update | 编辑案例 | 编辑案例内容 |
| case:delete | 删除案例 | 删除案例 |
| case:approve | 审核案例 | 审核案例发布 |

### 订餐管理模块

| 权限代码 | 权限名称 | 说明 |
|---------|---------|------|
| meal:menu | 查看菜单 | 查看订餐菜单 |
| meal:order | 订餐 | 提交订餐 |
| meal:cancel | 取消订餐 | 取消订餐 |
| meal:manage_menu | 管理菜单 | 管理菜单菜品 |
| meal:statistics | 订餐统计 | 查看订餐统计 |

### 消息管理模块

| 权限代码 | 权限名称 | 说明 |
|---------|---------|------|
| message:list | 查看消息 | 查看系统消息 |
| message:send | 发送消息 | 发送系统消息 |
| message:delete | 删除消息 | 删除消息 |

### 系统设置模块

| 权限代码 | 权限名称 | 说明 |
|---------|---------|------|
| system:config | 系统配置 | 修改系统配置 |
| system:log | 查看日志 | 查看系统日志 |
| system:backup | 数据备份 | 执行数据备份 |
| system:restore | 数据恢复 | 恢复数据 |

---

## API接口

### 角色管理

#### 获取角色列表
```http
GET /api/roles
```

#### 创建角色
```http
POST /api/roles
Content-Type: application/json

{
  "name": "角色名称",
  "description": "角色描述",
  "level": 5
}
```

#### 更新角色
```http
PUT /api/roles/:id
Content-Type: application/json

{
  "name": "新角色名称",
  "description": "新描述",
  "level": 6
}
```

#### 删除角色
```http
DELETE /api/roles/:id
```

### 权限管理

#### 获取权限列表
```http
GET /api/permissions
```

#### 获取角色的权限
```http
GET /api/roles/:id/permissions
```

#### 为角色添加权限
```http
POST /api/roles/:id/permissions
Content-Type: application/json

{
  "permission_id": 1
}
```

#### 移除角色的权限
```http
DELETE /api/roles/:roleId/permissions/:permissionId
```

### 用户角色管理

#### 获取用户列表（含角色）
```http
GET /api/users-with-roles
```

#### 获取用户的角色
```http
GET /api/users/:id/roles
```

#### 为用户分配角色
```http
POST /api/users/:id/roles
Content-Type: application/json

{
  "role_id": 1
}
```

#### 移除用户的角色
```http
DELETE /api/users/:userId/roles/:roleId
```

#### 获取用户的所有权限
```http
GET /api/users/:id/permissions
```

#### 检查用户是否有某个权限
```http
GET /api/users/:id/has-permission/:code
```

---

## 使用指南

### 1. 创建自定义角色

1. 进入 **权限管理** 页面
2. 点击 **添加角色** 按钮
3. 填写角色信息：
   - 角色名称：如"客服组长"
   - 角色描述：说明职责范围
   - 角色级别：1-10，建议3-7
4. 点击 **创建** 保存

### 2. 配置角色权限

1. 在角色列表中找到目标角色
2. 点击 **权限** 按钮
3. 在弹出的对话框中：
   - 按模块查看权限
   - 勾选需要的权限
   - 自动保存
4. 关闭对话框

### 3. 为用户分配角色

1. 切换到 **用户角色** 标签
2. 找到目标用户
3. 点击 **管理角色** 按钮
4. 勾选要分配的角色
5. 自动保存

### 4. 前端权限检查

```javascript
// 检查用户是否有某个权限
const hasPermission = async (userId, permissionCode) => {
  const response = await fetch(
    `http://localhost:3001/api/users/${userId}/has-permission/${permissionCode}`
  )
  const data = await response.json()
  return data.hasPermission
}

// 使用示例
if (await hasPermission(currentUser.id, 'employee:create')) {
  // 显示创建员工按钮
}
```

### 5. 后端权限检查

```javascript
// 权限检查中间件
async function checkPermission(permissionCode) {
  return async (request, reply) => {
    const userId = request.user.id
    const [rows] = await pool.query(`
      SELECT COUNT(*) as count
      FROM permissions p
      INNER JOIN role_permissions rp ON p.id = rp.permission_id
      INNER JOIN user_roles ur ON rp.role_id = ur.role_id
      WHERE ur.user_id = ? AND p.code = ?
    `, [userId, permissionCode])

    if (rows[0].count === 0) {
      return reply.code(403).send({ error: '没有权限' })
    }
  }
}

// 使用示例
fastify.post('/api/employees', {
  preHandler: [verifyToken, checkPermission('employee:create')]
}, async (request, reply) => {
  // 创建员工逻辑
})
```

---

## 最佳实践

### 1. 角色设计原则

- **最小权限原则**：只分配必要的权限
- **职责分离**：不同职责使用不同角色
- **层级清晰**：合理设置角色级别
- **避免过度细分**：角色数量适中

### 2. 权限分配建议

- **新员工**：先分配"普通员工"角色
- **客服人员**：分配"客服专员"角色
- **管理人员**：根据职责分配对应角色
- **多角色**：一个用户可以有多个角色

### 3. 安全建议

- **定期审计**：定期检查用户权限
- **及时回收**：员工离职及时删除账号
- **权限变更**：记录权限变更日志
- **敏感操作**：重要操作需要二次确认

### 4. 维护建议

- **文档更新**：权限变更及时更新文档
- **培训说明**：新角色需要培训说明
- **测试验证**：权限配置后要测试验证
- **备份数据**：定期备份权限配置

---

## 常见问题

### Q1: 如何给所有用户分配默认角色？

```sql
-- 为所有没有角色的用户分配"普通员工"角色
INSERT INTO user_roles (user_id, role_id)
SELECT u.id, 8 FROM users u
WHERE NOT EXISTS (
  SELECT 1 FROM user_roles ur WHERE ur.user_id = u.id
);
```

### Q2: 如何批量修改角色权限？

通过权限管理界面操作，或执行SQL：

```sql
-- 为角色ID=5添加某个权限
INSERT INTO role_permissions (role_id, permission_id)
VALUES (5, 权限ID);
```

### Q3: 系统角色可以修改吗？

系统角色（is_system=1）不能删除，但可以修改其权限配置。

### Q4: 用户有多个角色时权限如何计算？

用户拥有所有角色的权限并集，即只要任一角色有该权限即可。

---

## 技术支持

如有问题，请联系系统管理员或查看：

- 📖 [开发指南](./开发指南.md)
- 📖 [数据库设计文档](../雷犀客服系统数据库设计文档.md)
- 📖 [API文档](./API文档.md)

---

**文档版本**: v1.0
**更新时间**: 2024-11-09
**维护人员**: 系统开发团队
