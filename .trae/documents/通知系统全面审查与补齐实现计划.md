## 文档对照结论
- 数据库与基础后端：已实现（两张表与基础 CRUD 路由匹配 `tasks.md` 阶段一/三/五）。
- WebSocket 推送：已集成并在创建通知后推送 `notification:new` 给目标用户；`notification:update/delete` 未见落地（仅文档目标）。
- 前端组件：通知中心、发送页面、徽章、Toast 均已实现；“队列管理（最多 3–5 条）”未实现；偏好设置（免打扰/音效）存在组件但缺后端接口；统计（发送统计/阅读率/活跃度）缺失。
- 测试：无通知相关的单元/集成/e2e 测试。总体与 `tasks.md` 的 ✅ 标记不完全一致，需补齐。

## 差距与修复清单
- 队列管理：为 ToastContainer 增加 `limit={3}` 或 `{5}`；必要时在 `showNotificationToast` 增加去重逻辑。
- 客户端偏好设置：后端新增 `GET/PUT /api/user/notification-settings`（字段：接收系统/部门通知、音效开关、免打扰时间段、显示时长），前端接入保存/加载；免打扰在 `showNotificationToast` 中判断静默。
- 统计与报表：新增端点：
  - `GET /api/notifications/stats/overview`（发送量、阅读率）
  - `GET /api/notifications/stats/by-department`（部门维度）
  - `GET /api/notifications/stats/activity`（阅读行为趋势/活跃度）
  - `GET /api/notifications/unread-count`（未读数快捷接口）
  - 同步更新前端展示组件（NotificationHistory 或新增页面）。
- WebSocket 扩展：补齐 `notification:update`/`notification:delete` 事件触发；推送失败重试与离线缓存对齐当前逻辑。
- 测试补齐：
  - 前端：`showNotificationToast` 渲染测试（text/rich_text/image/link/mixed；优先级）；徽章轮询与未读数；通知中心筛选/分页/已读/删除。
  - 后端：路由状态码与权限覆盖；统计端点的计算正确性；Socket 推送房间与目标用户校验。
  - e2e：创建部门通知→目标用户接收→已读/删除→未读数与列表同步，含免打扰场景。

## 实施方案（不改动现有架构）
- 后端
  - 新增 `user_notification_settings` 表（user_id, receive_system, receive_department, sound_on, dnd_start, dnd_end, toast_duration）
  - 路由：`GET/PUT /api/user/notification-settings`；在 `notifications.js` 创建后根据目标用户设置过滤推送（或保留推送仅客户端静默）。
  - 统计端点：基于 `notifications` 与 `notification_recipients` 聚合查询返回统计数据。
  - `unread-count`：返回 `SELECT COUNT(*) FROM ... WHERE is_read=false`。
  - Socket：在通知编辑/删除时触发 `notification:update/delete` 给相关接收者。
- 前端
  - `App.jsx`：`<ToastContainer limit={3}>`；保持 `newestOnTop`。
  - `showNotificationToast`：可选去重与免打扰检查（读取用户设置，判断当前时间段静默或禁音）。
  - `NotificationSettings.jsx`：接入新 API，表单校验与保存提示。
  - 新增统计页面或扩展 `NotificationCenter` 支持概览卡片与趋势图（Chart.js）。
- 测试
  - 结构化测试文件：`tests/notifications/api.test.js`、`tests/notifications/socket.test.js`、`src/utils/notificationUtils.test.tsx`、`src/components/NotificationCenter.test.tsx`。

## 交付与验证
- 本轮不直接修改生产逻辑；先提交调整方案与端点定义
- 待确认后：补齐后端端点与前端接入；完善测试并跑通
- 最终更新 `/消息/tasks.md`：将未实现项标记为 ✅ 并补充实现说明与接口列表

如你确认以上计划，我将开始：后端新增“用户通知设置”和“统计端点”，前端接入设置与队列限制，完善测试，并统一更新文档实现状态。