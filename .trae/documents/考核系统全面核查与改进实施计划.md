## 概览
- 目标：对 tasks.md 的全部功能与技术要求进行落地核查、补齐后端 API、修正前端集成、补充测试与文档，使所有考试相关功能在前端可正常使用，并产出覆盖率报告与更新文档。
- 范围：试卷/题目/考核计划/考试参与/成绩管理/统计分析的后端与前端；核心功能（倒计时/自动保存/评分）；交互与性能；测试与文档。

## 需求提取（来自 tasks.md）
- 后端 API：
  - 试卷：GET 列表/GET 详情/POST 创建/PUT 更新/DELETE 删除/PUT 状态；试卷题目：GET 列表/GET 详情/POST 添加/PUT 更新/DELETE 删除/PUT 排序。
  - 考核计划：GET 列表/GET 详情/POST 创建/PUT 更新/DELETE 删除/PUT 状态/GET 参与者。
  - 考试参与：GET 我的考试/POST 开始考试/GET 考试进度/PUT 保存答案/POST 提交考试/GET 查看结果。
  - 成绩管理：GET 我的考试记录/GET 管理员考试记录/PUT 人工评分/GET 答题详情。
  - 统计分析：考试概览/试卷统计/用户统计/部门对比/题目分析/排名。
- 前端页面与组件：ExamList/ExamForm/ExamDetail/DragDropExamBuilder、QuestionList/QuestionEditor/QuestionImport、AssessmentPlanList/Detail/Form、MyExamList/ExamInstructions/ExamTaking/ExamResult、MyResults/AnswerDetail/ResultManagement、ExamStatistics/ExamAnalysis/UserAnalysis 等。
- 核心功能：倒计时（服务器时间同步、提醒、超时提交）、答案自动保存（防抖、本地缓存、定时同步、离线恢复）、自动评分（客观题、填空关键词、主观题待评分）。
- 体验优化与数据可视化、测试与安全性能、文档与部署。

## 代码库现状审查
- 后端：Fastify 已注册考核系统路由（server/index.js:3110-3114）。
  - exams 路由：已实现创建/更新/详情/状态/题目列表/题目详情/添加/更新/删除/排序/删除试卷（server/routes/exams.js，示例：详情 GET /api/exams/:id 在 server/routes/exams.js:299；题目列表 GET /api/exams/:examId/questions 在 server/routes/exams.js:556）。缺失：试卷列表 GET /api/exams。
  - assessment-plans 路由：列表/详情/创建/更新/状态/参与者/删除/我的考试 GET /api/my-exams（server/routes/assessment-plans.js）。注意：/api/my-exams 响应结构为 data.exams。
  - assessment-results 路由：开始考试/考试进度/保存答案/管理员人工评分/答题详情（server/routes/assessment-results.js）。缺失：提交考试 POST /api/assessment-results/:id/submit。
  - statistics 路由：考试概览/试卷/用户/部门/题目/排名（server/routes/statistics.js），字段命名与前端期望有差异（如 overall_pass_rate vs pass_rate；ranking 的字段名）。
  - 其他：服务器时间同步接口缺失（前端 hooks/useExamTimer.js 调用 /api/time/server 未找到）。
- 前端：React + AntD 组件与页面齐备（src/pages/Assessment 下完整组件集合）。
  - 关键页面：
    - ExamList.jsx 使用 GET /api/exams 并期望 data.exams + 分页（src/pages/Assessment/ExamList.jsx:25-45），后端未实现该 GET；发布/归档/删除已与后端匹配。
    - MyExamList.jsx 期望响应为 data.results（src/pages/Assessment/MyExamList.jsx:33），而后端返回 data.exams。
    - ExamTaking.jsx 使用 GET /api/assessment-results/:id、PUT 保存答案、POST 提交（src/pages/Assessment/ExamTaking.jsx），后端缺失提交端点；文件内存在重复片段需要整理。
    - ExamResult.jsx 期望结果结构与后端返回 result_summary/detailed_questions 不完全一致（src/pages/Assessment/ExamResult.jsx）。
    - ExamStatistics.jsx 期望统计端点返回字段名与结构与后端不一致（如 overall_pass_rate、data.ranking）（src/pages/Assessment/ExamStatistics.jsx）。
  - 核心功能 Hooks：
    - useExamTimer.js 提示调用 /api/time/server（src/hooks/useExamTimer.js:33）未实现；提醒逻辑完整。
    - useAutoSave.js 的签名与调用不一致：Hook 内 debouncedSave 调用 saveFunction(resultId, dataToSave)（src/hooks/useAutoSave.js:20-35），而 ExamTaking 中传参为 debouncedSaveAnswer(questionId, formattedAnswer)，导致 questionId 被当作 dataToSave，resultId 被当作 questionId（集成错误）。
- 测试与工具：package.json 未配置前端/后端测试框架；仅有 tests/README，无覆盖率工具。

## 差距与改进项（优先级 P0→P1→P2）
- P0 后端补齐与一致性：
  - 实现试卷列表 GET /api/exams（分页、筛选、搜索、返回字段与排序），响应结构与前端一致：data.exams、data.page、data.pageSize、data.total。
  - 实现提交考试 POST /api/assessment-results/:id/submit：按 tasks.md 自动评分客观题、多选部分分（如启用）与错误为 0，填空关键词匹配，主观题置待评分，汇总总分、用时、通过判断，更新状态 'submitted' 或 'graded'，返回结果结构与 ExamResult 前端期望一致或统一前端适配方案。
  - 添加服务器时间同步 GET /api/time/server 返回 ISO 时间，用于倒计时校正。
  - 统一响应字段：/api/my-exams 返回 data.exams→前端改用 exams；statistics 端点统一字段名（如 pass_rate→overall_pass_rate）、ranking 返回 data.results 或前端适配。
- P0 前端修复：
  - 修正 useAutoSave 与 ExamTaking 集成：将 debouncedSaveAnswer 接受(questionId, answer) 并在 Hook 内调用 saveFunction(questionId, answer)，或在调用侧传递统一 data 对象，保证保存正确。
  - 整理 ExamTaking.jsx 重复片段，保持单一实现。
  - 适配后端响应结构：MyExamList、ExamResult、ExamStatistics 字段与结构同步（统一字段映射）。
- P1 功能补全：
  - ExamList “查看/编辑/跳转”落地路由；ExamDetail 预览完善；DragDropExamBuilder 批量添加题目（目前仅逐个拖拽）。
  - 统计趋势端点或前端改为占位与说明（ExamStatistics 的 /api/statistics/score-trend）。
- P1 测试与覆盖率：
  - 引入 Vitest + React Testing Library（前端）与 Vitest/Supertest（后端）。
  - 编写单元与集成测试：API 路由（试卷/题目/计划/考试参与/成绩/统计）、核心 Hooks（倒计时/自动保存）、页面交互（答题、提交、查看结果）。
  - 配置覆盖率阈值（如 statements/branches/functions/lines≥80%），生成报告。
- P2 体验与安全：
  - 操作确认对话框/Toast/快捷键等交互优化；题目分页/虚拟滚动；防作弊日志上报与提示。

## 实施方案（分阶段）
- 阶段 1：后端补齐与统一（P0）
  - 添加 GET /api/exams：分页、筛选、搜索；与前端期望结构一致。
  - 添加 POST /api/assessment-results/:id/submit：实现评分与结果汇总；同步 answer_records 与 assessment_results；返回结构统一（可返回 result_summary + detailed_questions，前端改适配或返回平铺结构）。
  - 添加 GET /api/time/server：返回服务器当前时间。
  - 统一 statistics 返回字段（exam-overview 的 pass_rate 别名 overall_pass_rate；ranking 返回 data.results 或前端适配）。
- 阶段 2：前端适配与修复（P0）
  - 修复 useAutoSave 与 ExamTaking 参数契约；确保 PUT /api/assessment-results/:id/answer 接收 question_id 与 user_answer 正确。
  - MyExamList 使用 data.exams；ExamStatistics 使用后端当前字段（或做映射）；ExamResult 对接后端 result_summary/detailed_questions。
  - 清理 ExamTaking 重复代码、完善移动端抽屉导航与标记功能。
- 阶段 3：功能补全与交互（P1）
  - 完善 ExamDetail 预览；DragDropExamBuilder 批量添加题目 UI 与后端批量接口（可选：复用 POST 批量）。
  - 如果保留成绩趋势，设计 /api/statistics/score-trend（按日/周/月聚合）。
- 阶段 4：测试与覆盖率（P1）
  - 工具与配置：新增 Vitest、@testing-library/react、supertest、c8 覆盖率；CI 脚本。
  - 编写测试：
    - 后端：exams/assessment-plans/assessment-results/statistics 路由（鉴权/参数校验/事务/状态转换）；提交评分算法覆盖边界（多选/填空关键词）。
    - 前端：ExamTaking 自动保存与提交、倒计时提醒与超时；MyExamList 列表与开始考试；ExamResult 结果展示；ExamStatistics 数据呈现。
  - 产出覆盖率报告（HTML/文本）。
- 阶段 5：文档与交付（P1）
  - 创建“功能清单文档”：记录已完成功能、前端组件集成、待优化项。
  - 在 docs/ 或 文档/ 下更新项目说明与新增功能摘要；补充 API 字段说明差异与统一。

## 验证与交付
- 本地启动后端与前端，走通全流程：我的考试→开始考试→答题保存→提交评分→查看结果→统计页面。
- 运行测试套件并生成覆盖率报告；截图或存档报告到 docs。
- 更新项目文档；列出关键代码引用与接口清单。

## 关键代码引用（用于改动定位）
- 路由注册：server/index.js:3110-3114
- 试卷详情与题目列表：server/routes/exams.js:299，server/routes/exams.js:556
- 考核计划列表与我的考试：server/routes/assessment-plans.js（/api/assessment-plans、/api/my-exams）
- 考试进度/保存答案/人工评分/答题详情：server/routes/assessment-results.js
- 统计：server/routes/statistics.js
- 前端页面：src/pages/Assessment/ExamList.jsx、MyExamList.jsx、ExamTaking.jsx、ExamResult.jsx、ExamStatistics.jsx
- Hooks：src/hooks/useExamTimer.js、src/hooks/useAutoSave.js

请确认以上计划，确认后我将按阶段执行代码改动、测试与文档更新，并在交付中提供覆盖率报告与功能清单。