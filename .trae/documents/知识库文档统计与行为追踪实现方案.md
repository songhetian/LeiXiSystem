## 数据模型与存储
- 新增表（MySQL，配索引）：
  1) `knowledge_article_read_sessions`
  - 字段：`id, article_id, user_id, department_id, session_start, session_end, duration_seconds, active_seconds, scroll_depth_percent, wheel_events, mousemove_events, keypress_events, full_read TINYINT(1), close_type ENUM('user_close','auto_close','tab_hidden'), created_at`
  - 索引：`(article_id, session_start)`、`(user_id, session_start)`、`(department_id, session_start)`
  2) `knowledge_article_daily_stats`
  - 字段：`article_id, date, views, sessions, avg_duration_seconds, full_read_rate`
  - 索引：`(article_id, date)`
  3) 可选用户维度表 `knowledge_user_reading_stats`
  - 字段：`user_id, date, sessions, avg_duration_seconds, full_read_rate, preferred_hours_json`
- Redis 用途：心跳缓存与活跃窗口状态（Key：`kb:reading:{articleId}:{userId}:{sessionId}`，保存最近 N 次心跳与互动计数），定时/结束时批量落库
- 现有表复用：`knowledge_articles`（浏览量已实现 `view_count`），用户/部门关联来自 `users/department`

## 后端 API 设计（Fastify）
- 会话生命周期：
  - `POST /api/knowledge/articles/:id/reading/start` → 返回 `session_id`；记录 `session_start`；可选返回当前文章元信息
  - `PUT /api/knowledge/articles/:id/reading/heartbeat` → 参数：`session_id, active_delta, wheel, mousemove, keypress, scroll_depth_percent`；写入 Redis 累加；用于防作弊与活跃度判定
  - `PUT /api/knowledge/articles/:id/reading/end` → 参数：`session_id, close_type`；合并 Redis + 本地累计，写入 `knowledge_article_read_sessions`；计算 `full_read` 与更新 `daily_stats`
- 统计查询：
  - 文章维度：
    - `GET /api/knowledge/stats/articles/hot?timeRange=day|week|month&start&end&type` → 热门排行（按 `views/sessions/active_seconds` 权重可配）
    - `GET /api/knowledge/stats/articles/overview?start&end` → 浏览次数、完整阅读率、平均阅读时长（支持类型筛选）
    - `GET /api/knowledge/stats/articles/trend?articleId&start&end&bucket=day` → 文档热度趋势
  - 员工/部门维度：
    - `GET /api/knowledge/stats/users/habits?userId&start&end` → 阅读习惯（偏好时段、平均时长、滚动深度分布）
    - `GET /api/knowledge/stats/departments/mastery?departmentId&start&end&type` → 知识掌握度（完整阅读率、覆盖率）
  - 快捷未读/统计：
    - `GET /api/knowledge/stats/overview` → 系统级概览（总浏览、平均时长、完整率）
- 导出：
  - `GET /api/knowledge/stats/export/excel?scope=article|department|user&start&end`（Excel，使用现有 `exceljs`）
  - `GET /api/knowledge/stats/export/pdf?scope=overview|trend`（PDF，可优先返回服务器生成的静态报表，若当前不引入 PDF 库则先提供 CSV/PNG 图表导出）
- 防作弊与阈值：
  - 后端校验：最小有效时长（默认 5 秒）；活跃占比（`active_seconds/duration_seconds ≥ 0.6`）与滚动覆盖（`scroll_depth_percent ≥ 80%`）满足才记为 `full_read`
  - 空闲检测：连续心跳缺少互动（mousemove/wheel/keypress）时，暂停累加 `active_seconds`

## 前端行为追踪（React + Web API）
- 可复用 Hook：`useReadingTracker(articleId)`
  - DOMContentLoaded 开始计时；Page Visibility API + `beforeunload/pagehide` 结束或暂停
  - 心跳：`setInterval` 每 10–15 秒，携带 `active_delta`；卸载时用 `navigator.sendBeacon` 发送最终心跳与 `end`
  - 互动监听：`wheel/mousemove/keydown` 增加计数与活跃标记（节流）
  - 滚动覆盖：计算阅读区域的最大滚动百分比（容器高度与 scrollTop），用于完整阅读率判定
  - 关闭类型区分：`pagehide`（系统自动）、`beforeunload`（主动关闭）、`visibilitychange`（标签隐藏）
- 集成位置：
  - 文章详情页（`Win11KnowledgeBase/Win11KnowledgeFolderView` 的文章查看组件）中调用 Hook
  - 心跳失败重试与离线缓存（IndexedDB 可选，当前先以内存 + sendBeacon）

## 统计查询与高级搜索
- 组合筛选参数：时间段（日/周/月/自定义），部门/员工，文档类型
- 返回结构统一 `{ success, data, pagination? }`
- 图表与可视化：
  - 使用现有 `react-chartjs-2` + `chart.js` 渲染趋势与分布（条形图/折线图/饼图）
  - 交互：缩放/筛选联动，数据下钻（点击部门→员工→文章列表）
- 导出：
  - Excel：使用 `exceljs`（已在 `package.json`）生成多 sheet 报表
  - PDF：若不引入新库，先提供 CSV + 客户端 PDF 打印（或后端使用常用 PDF 库在后续迭代补齐）

## 性能与安全
- Redis 缓存心跳，批量合并进入 MySQL；对热点文章启用聚合缓存（如 5 分钟窗口）
- 限流与压采集：心跳间隔 ≥ 10s；互动事件节流（如 300ms）
- 隐私保护：不记录具体鼠标轨迹与键入内容，仅计数与时长；只存用户/部门维度与文章 ID
- 异常容错：sendBeacon 失败回退到 `fetch`，或在下次打开页面补交（带上最近 sessionId）

## 测试与验证
- 单元测试：Hook 时间与事件聚合逻辑；后端计算完整阅读率与活跃度
- 集成测试：启动/心跳/结束全链路；统计接口筛选与导出
- e2e：模拟阅读行为（滚动/停留/离开），校验趋势与排行；防作弊阈值生效

## 迭代里程碑
- 第 1 周：后端会话生命周期接口 + Redis 缓存与 MySQL 落库；集成文章页 Hook（基础时长/心跳/结束）
- 第 2 周：完整阅读率、热门排行、平均时长；图表页与概览；Excel 导出
- 第 3 周：高级搜索与部门/员工统计；防作弊增强与缓存优化；PDF/下钻与更多可视化

## 与现有系统的衔接
- 复用已有 `knowledge_articles` 与 `view` 计数接口；新增统计端点统一前缀 `/api/knowledge/stats/*`
- 统一响应结构与分页模型；权限沿用现有 `users/roles/departments` 体系（仅统计视图可访问）

请确认以上方案，我将开始实现后端统计与前端行为追踪 Hook，并补齐报表与导出接口。