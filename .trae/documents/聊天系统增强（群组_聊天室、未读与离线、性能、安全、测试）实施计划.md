## 概述
- 目标：补齐聊天系统后端群组/聊天室完整能力，完善未读与离线消息逻辑，前端性能与安全优化，并建立测试体系，确保≥80%代码覆盖率。
- 范围：后端 REST + Socket 事件、前端 UI/交互与虚拟滚动、敏感词统一校验、测试框架与用例、文档更新。

## 后端实现
### 数据结构与表
- 复用/完善：conversations、conversation_members、messages、message_status。
- 新增/补充：groups、group_members、chat_rooms、room_members（按聊天任务文档中的字段）。

### 群组 API（/api/chat/groups）
- POST /groups 创建群：name、avatar、description、owner_id、announcement、join_approval_required、max_members。
- GET /groups/:id 获取信息：基本信息、成员列表与角色、公告。
- PUT /groups/:id 更新群信息：仅管理员/群主可更改。
- DELETE /groups/:id 解散群：校验所有者。
- POST /groups/:id/members 邀请成员：添加到 group_members 与 conversation_members。
- DELETE /groups/:id/members/:userId 移除成员：处理会话成员与未读状态清理。
- PUT /groups/:id/members/:userId/role 设置角色：member/admin/owner。
- POST /groups/:id/leave 成员退出。

### 聊天室 API（/api/chat/rooms）
- POST /rooms 创建聊天室：name、avatar、category、is_public、password（加密存储）、max_members。
- GET /rooms 列表：支持分类/关键词与分页。
- GET /rooms/:id 详情：基本信息、当前在线人数与成员列表。
- PUT /rooms/:id 更新：管理员/创建者权限控制。
- DELETE /rooms/:id 删除：仅创建者。
- POST /rooms/:id/join|leave 加入/离开：校验公开与密码；同步 room_members 与在线计数。

### 消息与状态
- 撤回/删除：已实现；补齐服务端校验权限（仅发送者或管理员）与审计日志。
- 未读计数：
  - 写入消息时在 message_status 初始化 sent/delivered 并对非发送者成员递增未读。
  - 客户端 `message:read` 批量标记 read，并通过 Socket 广播 `conversation:unread:update`。
- 离线消息：
  - 登录/重连时根据 message_status 中非 read 且时间窗口（如最近 N 天）拉取并通过 `offline:messages` 推送；同时返回未读计数。

### Socket 事件
- 连接：user:online/user:offline；会话房间加入（以 conversation_id 为房间）。
- 消息：message:send/receive/recall/delete/read；typing。
- 会话：conversation:update；群：group:create/member:join|leave/update；聊天室：room:join|leave/message。

## 前端实现
### 群组与聊天室页面
- GroupInfo：展示群信息、成员列表、公告与设置；支持邀请/移除成员与角色设置；退出群组与解散。
- ChatRoomList：分类筛选与搜索、分页；创建聊天室按钮。
- ChatRoom：加入/离开按钮、在线成员侧栏、消息区域复用 ChatWindow；房间消息通过 `room:message`。

### 未读/离线与消息交互
- 会话选择时触发 `message:read`，服务端回传未读变更；前端更新徽章。
- 重连后处理 `offline:messages` 合并；对撤回/删除事件实时更新消息列表。

### 性能优化
- 虚拟滚动：在 ChatWindow 中使用 react-window（若无需新依赖则实现轻量窗口化）渲染长列表；仅保留可视区域 DOM。
- 媒体懒加载：图片使用 `loading="lazy"` 与 IntersectionObserver；视频以封面预览，点击后加载播放器。

### 安全与敏感词
- 前端词典：统一在 `src/utils/sensitiveWords.js` 维护；发送前本地提示或阻止。
- 后端校验：统一规则在 `server/utils/sensitiveWords.js`，发送与编辑校验；返回明确错误码与文案。
- XSS：富文本显示通过 DOMPurify（已存在 LazyImageRenderer 中使用），统一在消息渲染层应用。

## 测试体系
### 依赖与脚本
- 添加：vitest、@testing-library/react、c8；可选 E2E：playwright 或 cypress。
- 脚本：`npm run test`（vitest 全局）、`npm run coverage`（c8 生成报告）。

### 测试内容
- 单元：
  - 组件（ConversationList/ChatWindow/MessageInput/消息组件）：渲染与交互、菜单、虚拟滚动窗口化。
  - Hooks/Utils：Socket 管理、敏感词检测、懒加载工具。
- 集成：
  - API：群组/聊天室 CRUD、成员管理、消息撤回/删除、搜索、收藏、未读更新。
  - Socket：消息收发、撤回/删除广播、未读事件、离线消息同步。
- 覆盖率：statements/branches/functions/lines ≥ 80%，输出 HTML 与文本报告。

## 迁移与验证
- 数据库迁移脚本：补充 groups/group_members/chat_rooms/room_members/message_status 索引与结构。
- 本地验证：启动后端（释放 3001 端口）、进入“聊天通讯”，验证会话与聊天室全流程。
- 文档：更新 `docs/chat-feature-checklist.md` 与新增测试运行说明、覆盖率报告位置。

## 交付
- 后端：群组/聊天室完整 API、未读与离线消息逻辑、Socket 事件完善。
- 前端：群组与聊天室 UI、虚拟滚动与媒体懒加载、敏感词统一校验。
- 测试：Vitest/RTL 与 c8 覆盖，必要的集成与端到端测试说明。

请确认该计划，确认后我将分批次实施后端与前端改动、新增测试与文档，并完成端到端验证与覆盖率报告。