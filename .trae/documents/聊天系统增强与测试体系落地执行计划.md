## 执行里程碑
- 里程碑1：后端补齐群组与聊天室 CRUD 与成员管理、加入/退出，统一未读与离线消息逻辑（Socket 广播）
- 里程碑2：前端群组/聊天室页面完善，消息撤回/删除交互联动，未读徽章与离线合并
- 里程碑3：性能与安全优化（虚拟滚动、媒体懒加载、敏感词前后端统一）
- 里程碑4：测试体系接入（Vitest/RTL/c8），编写单元与集成测试并达成≥80%覆盖率

## 详细实施步骤
### 1. 后端实现（API + Socket）
- 数据库：新增/补充表与索引
  - groups(id,name,avatar,description,announcement,owner_id,max_members,is_public,join_approval_required,created_at,updated_at)
  - group_members(id,group_id,user_id,role,joined_at,invited_by)
  - chat_rooms(id,name,avatar,description,category,is_public,password,max_members,current_members,creator_id,created_at)
  - room_members(id,room_id,user_id,joined_at,last_active_at)
  - message_status(id,message_id,user_id,status,read_at)，为 message_id+user_id 建唯一索引
- 群组 API（/api/chat/groups）
  - POST /groups：创建群组并创建对应会话记录与 conversation_members
  - GET /groups/:id：返回群组信息与成员列表、角色
  - PUT /groups/:id：仅群主/管理员可更新
  - DELETE /groups/:id：解散群组并清理 conversation_members
  - POST /groups/:id/members：邀请成员（批量），更新 group_members+conversation_members
  - DELETE /groups/:id/members/:userId：移除成员
  - PUT /groups/:id/members/:userId/role：设置角色
  - POST /groups/:id/leave：成员退出，处理未读与订阅房间退出
- 聊天室 API（/api/chat/rooms）
  - POST/GET/GET/:id/PUT/DELETE 完整 CRUD（密码用 bcrypt 加密）
  - POST /rooms/:id/join|leave：校验公开与密码，更新 room_members 与 current_members
- 消息状态与广播
  - 写入消息：为会话成员插入 message_status(sent/delivered)，非发送者的未读计数+1
  - 读取消息：PUT /messages/:id/read 或 Socket 事件 message:read 批量 read，并广播 conversation:unread:update
  - 离线消息：用户上线/重连时推送 offline:messages（最近 N 天未读消息）与会话未读计数快照
- Socket 事件
  - user:online/offline；conversation 房间加入；message:send/receive/recall/delete/read；message:typing
  - group:create/member:join|leave/update；room:join/leave/message

### 2. 前端实现（页面与交互）
- 群组页面：`src/components/Chat/GroupInfo.jsx`
  - 显示群信息、公告、成员列表（角色徽章）
  - 操作：邀请/移除成员、设置管理员、退出群组、解散群组
  - API 对接：GET/PUT/POST/DELETE groups 路由
- 聊天室列表与详情：`ChatRoomList.jsx`、`ChatRoom.jsx`
  - 列表：分类筛选、搜索、分页、创建
  - 详情：加入/退出、在线成员侧栏、消息区域复用 ChatWindow；房间消息使用 room:message
- 消息交互完善
  - 对自己的消息支持撤回/删除（已接入 API 与广播）
  - 选择会话触发 message:read，未读徽章实时更新
  - 重连处理 offline:messages 合并本地消息

### 3. 性能与安全优化
- 虚拟滚动：在 `ChatWindow` 使用 react-window（或轻量窗口化）渲染长列表，保留可视窗口 DOM 并支持“上拉加载更多”
- 媒体懒加载：图片统一 `loading="lazy"` + IntersectionObserver；视频使用封面，点击加载播放器
- 敏感词：
  - 前端：`src/utils/sensitiveWords.js` 统一词典与检测，发送前提示/阻止
  - 后端：`server/utils/sensitiveWords.js` 统一规则，发送与编辑进行校验，返回明确错误码
- XSS：富文本渲染统一 DOMPurify（复用 LazyImageRenderer），消息文本转义或白名单渲染

### 4. 测试体系接入
- 依赖：新增 vitest、@testing-library/react、c8；可选 playwright/cypress
- 脚本：`npm run test`（vitest），`npm run coverage`（c8）
- 单元测试：ConversationList/ChatWindow（含虚拟滚动）/MessageInput/消息组件；Socket 管理、敏感词检测
- 集成测试：群组/聊天室 CRUD 与成员、消息撤回/删除、搜索、收藏、未读更新；Socket 消息广播与离线同步
- 目标：覆盖率（statements/branches/functions/lines）均≥80%，生成 HTML 与文本报告

## 交付与验证
- 数据库迁移：提供 SQL 脚本与回滚方案
- 端到端验证：启动后端（释放 3001 端口）、前端进入“聊天通讯”，验证会话/群组/聊天室流程（消息发送/撤回/删除、未读同步、离线消息）
- 文档：更新 `docs/chat-feature-checklist.md`，新增测试运行说明与覆盖率报告位置

## 风险与应对
- 高并发未读计算：通过索引与批量写入优化 message_status；必要时采用 Redis 计数缓存
- 房间在线统计准确性：Socket 断开事件与心跳机制保障；异常断开重算在线人数
- 虚拟滚动边界：保证滚动锚点与增量加载准确，提供回到底部按钮

请确认，确认后我将立即开始分批次实现与提交代码、测试与文档更新。