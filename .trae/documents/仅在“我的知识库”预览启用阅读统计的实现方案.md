## 范围与约束
- 仅在“我的知识库”页面的预览窗口（模态或附件预览）开启行为追踪与阅读统计；公共知识库/其他页面不启用。
- 目标组件：`Win11MyKnowledgeBase`（以及它的预览模块）；不在 `Win11KnowledgeBase/Win11KnowledgeFolderView` 等组件安装 Hook。

## 实施与交付
- 数据库：新增 `knowledge_article_read_sessions` 与 `knowledge_article_daily_stats` 表（020、021 迁移）。
- 后端接口：实现阅读会话生命周期与统计查询。
  - `POST /api/knowledge/articles/:id/reading/start` → 返回 `session_id`
  - `PUT /api/knowledge/articles/:id/reading/heartbeat` → 累加活跃秒数与事件计数
  - `PUT /api/knowledge/articles/:id/reading/end` → 合并、持久化并更新日统计
  - `GET /api/knowledge/stats/articles`、`GET /api/knowledge/stats/users`
- 前端集成：在 `Win11MyKnowledgeBase.jsx` 与 `MyKnowledgeBase.jsx` 预览模态安装 `useReadingTracker`，仅在模态打开时启用。
- 展示：在“我的知识库”操作栏添加“查看统计”面板，拉取最近 7 天文章统计并显示。

## 接入说明
- 完整阅读判定：`duration_seconds ≥ 5`，且 `active_seconds/duration_seconds ≥ 0.6`，且 `scroll_depth_percent ≥ 80%`。
- 心跳频率：约 12 秒；活跃检测：滚轮/鼠标/键盘，30 秒无交互视为不活跃。
- 仅在“我的知识库”预览触发；公共知识库页面不安装 Hook。

## 测试
- 新增测试：`tests/test-knowledge-reading.js`（会话起止与落库）、`tests/test-knowledge-stats.js`（文章统计查询）。
- 运行方式：`node tests/test-knowledge-reading.js`（需设置 `TEST_TOKEN`），`node tests/test-knowledge-stats.js`。

## 兼容性
- 复用现有 Fastify、MySQL、Redis 初始化；路由已注册于 `server/index.js`。
- 不影响现有知识库 API 与页面；仅在“我的知识库”预览启用追踪。

## 前端实现
- 新增 Hook：`useReadingTracker(articleId)`
  - 触发时机：在“我的知识库”预览打开时调用；关闭预览时自动上报结束。
  - 计时：从 `DOMContentLoaded` 或预览容器渲染完成开始；在 `beforeunload/pagehide/visibilitychange` 或模态关闭时结束；使用 `navigator.sendBeacon` 兜底。
  - 心跳：每 10–15 秒发送 `active_delta` 与事件计数（滚轮/鼠标移动/键盘），滚动覆盖百分比；失败重试一次，随后依赖结束上报合并。
  - 行为检测：监听 `wheel/mousemove/keydown`（300ms 节流）标记活跃；无交互连续 30 秒不累加活跃时长。
  - 关闭类型：区分 `user_close`（点击关闭模态）、`auto_close`（路由或卸载）、`tab_hidden`（标签隐藏）。
  - 集成：仅在 `Win11MyKnowledgeBase` 的预览模态组件内使用该 Hook；其他页面不导入。

## 后端接口（沿用此前方案）
- 阅读会话生命周期：
  - `POST /api/knowledge/articles/:id/reading/start` → 返回 `session_id`；记录起始时间与用户、部门。
  - `PUT /api/knowledge/articles/:id/reading/heartbeat` → 累加心跳指标（活跃秒数、事件计数、滚动覆盖）。
  - `PUT /api/knowledge/articles/:id/reading/end` → 合并会话数据落库，计算 `duration_seconds/active_seconds/full_read/close_type`。
- 数据模型：`knowledge_article_read_sessions` 与 `knowledge_article_daily_stats`（含索引）；Redis 做心跳缓存以批量合并。
- 防作弊与阈值：最小有效时长 5 秒；`active_seconds/duration_seconds ≥ 0.6` 且 `scroll_depth_percent ≥ 80%` 记为完整阅读。

## 统计与报表（仅统计“我的知识库”产生的会话）
- 文章维度：浏览次数、完整阅读率、平均阅读时长、热门排行；支持时间段、文档类型筛选。
- 部门/员工维度：个人阅读习惯与部门掌握度；图表使用 `react-chartjs-2`。
- 导出：Excel（`exceljs`）；PDF 二期补齐。

## 性能与安全
- 心跳与事件节流；Redis 缓存批处理；统计聚合窗口（5 分钟）。
- 仅记录计数与时长，不记录鼠标轨迹或键入内容；响应结构统一。

## 测试与验证
- 单元：Hook 计时与活跃度；后端完整阅读率计算。
- 集成：预览→心跳→结束全链路；统计查询与导出。
- e2e：在“我的知识库”预览模拟阅读，其他页面不触发上报。

## 迭代计划
- 第 1 步：后端会话接口与表；前端 Hook 在 `Win11MyKnowledgeBase` 预览接入。
- 第 2 步：统计接口与图表页；Excel 导出。
- 第 3 步：高级搜索与下钻；防作弊增强与缓存优化。
