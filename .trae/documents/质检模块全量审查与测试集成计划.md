## 现状评估
- 后端框架: Fastify 4，主入口 `server/index.js`；质检路由集中在 `server/routes/quality-inspection.js`
- 数据库: MySQL，迁移脚本位于 `database/migrations/*.sql`；质检相关核心表均已存在
- 前端: React + Vite；质检与案例库页面已实现（列表/评分/统计/推荐），但“案例详情/创建/编辑”独立页面缺失
- 测试: 未配置统一测试框架；质检模块无单元/集成/e2e 测试

## 与需求对照
- 会话管理与评分: 全部端点已实现（创建/列表/详情/更新/删除/消息/评分/会话评分详情/统计）
- 规则管理: 全部端点已实现（创建/列表/详情/更新/删除/启停）
- 评分管理: 全部端点已实现（提交/列表/修改/统计）
- 案例库: 端点基本齐全（创建/列表/详情/更新/删除/点赞/浏览/热门/推荐/收藏/学习记录/导出/报告），标签筛选未落地
- 前端页面: 列表/评分/规则/统计/推荐已落地；案例详情/创建/编辑页面未落地

## 主要问题
- 字段命名不一致
  - `quality_cases` 迁移使用 `view_count`/`like_count`，后端/前端使用 `views`/`likes` 读取与排序（如 `server/routes/quality-inspection.js:495, 513, 856, 1221, 1225`；`src/pages/CaseLibraryPage.jsx:154-157, 203-207`，`src/pages/CaseRecommendationPage.jsx:65-66, 85-86`，`src/pages/QualityReportPage.jsx:136, 146`）
  - `case_comments` 迁移使用 `comment_content`/`like_count`，后端使用 `comment_text`/`likes`（`server/routes/quality-inspection.js:661, 706, 743`；迁移 `database/migrations/013_create_case_comments_table.sql:8, 10`）
  - 附件排序字段：后端使用 `uploaded_at`，迁移为 `created_at`（`server/routes/quality-inspection.js:784`；迁移 `database/migrations/012_create_case_attachments_table.sql:11`）
  - 消息发送者类型：迁移 `sender_type` 示例为 `customer`/`agent`，前端判断为 `customer_service`（`src/components/QualityInspection.jsx:319-321`；迁移 `007_create_session_messages_table.sql:6`）
- 外键不一致
  - `case_comments.user_id` 外键指向 `employees(id)`，后端联表使用 `users`（迁移 `013_create_case_comments_table.sql:14`；代码 `server/routes/quality-inspection.js:685`）
- 接口返回形态不一致
  - 规则列表接口返回 `{ success, data }`，前端按数组处理（`src/pages/QualityRuleManagementPage.jsx:27`）
- 安全与健壮性
  - 案例列表 `sortBy` 未校验，存在 SQL 注入风险（`server/routes/quality-inspection.js:582`）
  - 标签筛选未实现（`server/routes/quality-inspection.js:575-577` 注释）
  - 规则创建 SQL 使用 `JSON_UNQUOTE(scoring_standard)` 列名不合法（`server/routes/quality-inspection.js:232`）

## 修复方案
- 统一字段
  - 后端/前端统一使用迁移字段：将所有 `views`→`view_count`、`likes`→`like_count`；`comment_text`→`comment_content`；附件排序字段使用 `created_at`
  - `sender_type`：前端统一识别 `agent` 为“客服”，`customer` 为“客户”，移除对 `customer_service` 的依赖
- 外键修正
  - 将 `case_comments.user_id` 外键指向 `users(id)`；联表显示昵称用 `users` 表
- 接口返回一致化
  - 保持后端 `{ success, data, pagination? }` 形态；前端统一按该结构读取（例如规则列表 `setRules(response.data.data)`）
- 安全加固
  - 为 `sortBy`/`sortOrder` 增加白名单校验（如 `['created_at','view_count','like_count']`）
  - 为筛选入参进行类型/范围校验，并对 `search` 做转义处理
- 需求补齐
  - 案例标签筛选：联表 `case_tags` 与 `tags`，支持多标签筛选；前端增加标签选择器
  - 新增页面：`CaseDetailPage.jsx`、`CaseEditorPage.jsx`（创建/编辑，富文本/标签/附件上传）

## 测试计划
- 后端（Supertest）
  - 会话: 创建参数校验/分页筛选/详情不存在返回 404/评分事务成功与回滚
  - 规则: JSON 字段入库/启停切换/重复名约束
  - 评分: 唯一约束（同一会话同一规则）/修改校验
  - 案例: 列表排序与筛选（分类/难度/关键词，视/赞字段一致）/热门与推荐返回结构/导出 CSV 头与内容
  - 评论: 增删改查与点赞计数字段正确（`like_count`）
  - 附件: 列表按 `created_at` 排序/下载 302 重定向
  - 收藏与学习记录: 增删/去重/分页
- 前端（Vitest + React Testing Library）
  - 质检列表与评分对话框交互（加载态/错误态/提交成功刷新）
  - 规则管理（创建/编辑/启停）JSON 编辑器解析与回填
  - 案例库（筛选/排序/分页/收藏/导出）视/赞展示与交互
  - 推荐/统计页面数据渲染与图表生成
- 覆盖率：`c8` 统计，后端/前端关键路径覆盖率 ≥ 70%

## 集成准备
- 修复完成并通过测试后：
  - 与现有模块接口对齐（`users`、`employees`、`tags`/`tag_categories`）
  - 更新 `API接口文档` 与 `数据库设计文档`（字段/外键/返回结构）
  - 版本记录：`CHANGELOG` 增加“质检模块字段一致化与安全加固”

## 集成实施
- 按部署流程：运行迁移、发布后端、构建前端、联调桌面端（Electron）
- 集成测试：
  - 冒烟用例覆盖 10+ 条典型场景（会话/规则/案例/评论/附件/导出）
  - 回归测试确保聊天/权限/学习中心未受影响
- 监控与回滚
  - 启用错误日志与接口探针；如遇严重问题，按版本回滚

## 验收标准
- 所有修复项落地，端到端测试全部通过
- 需求清单对应项状态为“完成”，包含标签筛选与页面补齐
- 无已知安全问题（排序白名单、入参校验、事务与唯一约束生效）