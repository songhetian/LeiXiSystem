# 软删除功能说明

## 功能概述

系统所有的"删除"操作都改为"软删除"，即不真正删除数据，只是将状态标记为"已删除"（deleted），可以随时恢复。

## 适用范围

✅ **部门管理** - 删除部门时同步删除该部门所有员工
✅ **职位管理** - 删除职位
✅ **员工管理** - 删除员工

## 软删除机制

### 什么是软删除？

软删除（Soft Delete）是一种数据保护机制：
- ❌ 不真正从数据库删除记录
- ✅ 只是将状态字段改为 `deleted`
- ✅ 数据仍然保留在数据库中
- ✅ 可以随时恢复

### 与硬删除的区别

| 特性 | 软删除 | 硬删除 |
|------|--------|--------|
| 数据保留 | ✅ 保留 | ❌ 永久删除 |
| 可恢复 | ✅ 可以 | ❌ 不可以 |
| 数据安全 | ✅ 高 | ❌ 低 |
| 误操作风险 | ✅ 低 | ❌ 高 |
| 数据审计 | ✅ 完整 | ❌ 丢失 |

## 使用说明

### 部门管理

#### 删除部门

1. **操作步骤**：
   - 在部门列表中找到要删除的部门
   - 点击"删除"按钮
   - 确认删除操作

2. **确认提示**：
   ```
   确定要删除这个部门吗？

   该部门有 X 名员工，删除后员工也将被标记为删除状态。

   删除后可以随时恢复。
   ```

3. **删除效果**：
   - 部门状态变为"已删除"
   - 该部门所有员工状态变为"已删除"
   - 默认列表中不再显示
   - 数据仍保留在数据库中

#### 恢复部门

1. **显示已删除部门**：
   - 勾选"显示已删除"复选框
   - 列表中显示所有部门（包括已删除）

2. **恢复操作**：
   - 找到已删除的部门（红色"已删除"标签）
   - 点击"恢复"按钮
   - 确认恢复操作

3. **恢复效果**：
   - 部门状态变为"启用"
   - 该部门所有员工状态变为"启用"
   - 重新显示在默认列表中

### 职位管理

#### 删除职位

1. **操作步骤**：
   - 点击"删除"按钮
   - 确认删除

2. **删除效果**：
   - 职位状态变为"已删除"
   - 不影响已分配该职位的员工
   - 默认列表中不再显示

#### 恢复职位

1. **显示已删除职位**：
   - 勾选"显示已删除"复选框

2. **恢复操作**：
   - 点击"恢复"按钮
   - 职位重新可用

### 员工管理

#### 删除员工

1. **操作步骤**：
   - 点击"删除"按钮
   - 确认删除

2. **删除效果**：
   - 员工状态变为"已删除"
   - 默认列表中不再显示
   - 用户账号保留

#### 恢复员工

1. **显示已删除员工**：
   - 勾选"显示已删除"复选框

2. **恢复操作**：
   - 点击"恢复"按钮
   - 员工状态变为"启用"

## 界面示例

### 部门管理界面

#### 默认视图（不显示已删除）
```
┌─────────────────────────────────────────────────────────┐
│ 部门管理                                                │
│ 共 5 个部门                                             │
│                                                         │
│ □ 显示已删除    [+ 新增部门]                           │
├─────────────────────────────────────────────────────────┤
│ 部门名称 │ 描述 │ 人数 │ 状态  │ 创建时间 │ 操作      │
├─────────────────────────────────────────────────────────┤
│ 客服部   │ ... │ 5人  │ [启用] │ 2024/1/1 │ 编辑 删除 │
│ 技术部   │ ... │ 8人  │ [启用] │ 2024/1/1 │ 编辑 删除 │
└─────────────────────────────────────────────────────────┘
```

#### 显示已删除视图
```
┌─────────────────────────────────────────────────────────┐
│ 部门管理                                                │
│ 共 5 个部门 (2 个已删除)                               │
│                  │
│ ☑ 显示已删除    [+ 新增部门]                           │
├─────────────────────────────────────────────────────────┤
│ 部门名称 │ 描述 │ 人数 │ 状态      │ 创建时间 │ 操作  │
├─────────────────────────────────────────────────────────┤
│ 客服部   │ ... │ 5人  │ [启用]    │ 2024/1/1 │ 编辑 删除 │
│ 技术部   │ ... │ 8人  │ [启用]    │ 2024/1/1 │ 编辑 删除 │
│ 市场部   │ ... │ 0人  │ [已删除]  │ 2024/1/1 │ 恢复      │
│ 销售部   │ ... │ 0人  │ [已删除]  │ 2024/1/1 │ 恢复      │
└─────────────────────────────────────────────────────────┘
```

### 删除确认对话框

```
┌─────────────────────────────────────┐
│ 确认删除                            │
├─────────────────────────────────────┤
│ 确定要删除这个部门吗？              │
│                                     │
│ 该部门有 5 名员工，删除后员工也将   │
│ 被标记为删除状态。                  │
│                                     │
│ 删除后可以随时恢复。                │
│                                     │
│              [取消]  [确定]         │
└─────────────────────────────────────┘
```

### 恢复确认对话框

```
┌─────────────────────────────────────┐
│ 确认恢复                            │
├─────────────────────────────────────┤
│ 确定要恢复这个部门吗？              │
│                                     │
│ 恢复后部门和员工状态将变为启用。    │
│                                     │
│              [取消]  [确定]         │
└─────────────────────────────────────┘
```

## 技术实现

### 后端API

#### 软删除API

```javascript
// 部门软删除
fastify.delete('/api/departments/:id', async (request, reply) => {
  // 将部门状态改为 deleted
  await pool.query('UPDATE departments SET status = ? WHERE id = ?', ['deleted', id])

  // 同时将该部门的所有员工状态改为 deleted
  await pool.query(`
    UPDATE employees e
    LEFT JOIN users u ON e.user_id = u.id
    SET e.status = 'deleted'
    WHERE u.department_id = ?
  `, [id])

  return { success: true, message: '部门已删除（可恢复）' }
})
```

#### 恢复API

```javascript
// 部门恢复
fastify.post('/api/departments/:id/restore', async (request, reply) => {
  // 恢复部门状态为 active
  await pool.query('UPDATE departments SET status = ? WHERE id = ?', ['active', id])

  // 同时恢复该部门的所有员工状态为 active
  await pool.query(`
    UPDATE employees e
    LEFT JOIN users u ON e.user_id = u.id
    SET e.status = 'active'
    WHERE u.department_id = ? AND e.status = 'deleted'
  `, [id])

  return { success: true, message: '部门已恢复' }
})
```

#### 列表API（支持过滤）

```javascript
// 获取部门列表
fastify.get('/api/departments', async (request, reply) => {
  const { includeDeleted } = request.query
  let query = 'SELECT * FROM departments'

  // 默认不显示已删除的部门
  if (includeDeleted !== 'true') {
    query += ' WHERE status != "deleted"'
  }

  query += ' ORDER BY sort_order, created_at DESC'

  const [rows] = await pool.query(query)
  return rows
})
```

### 前端实现

#### 状态管理

```javascript
const [showDeleted, setShowDeleted] = useState(false)

// 根据 showDeleted 状态获取数据
const fetchDepartments = async () => {
  const url = showDeleted
    ? 'http://localhost:3001/api/departments?includeDeleted=true'
    : 'http://localhost:3001/api/departments'
  const response = await fetch(url)
  const data = await response.json()
  setDepartments(data)
}
```

#### 删除处理

```javascript
const handleDelete = async (dept) => {
  const employeeCount = dept.employee_count || 0
  let confirmMsg = '确定要删除这个部门吗？\n\n'

  if (employeeCount > 0) {
    confirmMsg += `该部门有 ${employeeCount} 名员工，删除后员工也将被标记为删除状态。\n\n`
  }

  confirmMsg += '删除后可以随时恢复。'

  if (!confirm(confirmMsg)) return

  const response = await fetch(`http://localhost:3001/api/departments/${dept.id}`, {
    method: 'DELETE'
  })

  if (response.ok) {
    toast.success('部门已删除（可恢复）')
    fetchDepartments()
  }
}
```

#### 恢复处理

```javascript
const handleRestore = async (id) => {
  if (!confirm('确定要恢复这个部门吗？\n\n恢复后部门和员工状态将变为启用。')) return

  const response = await fetch(`http://localhost:3001/api/departments/${id}/restore`, {
    method: 'POST'
  })

  if (response.ok) {
    toast.success('部门已恢复')
    fetchDepartments()
  }
}
```

## 数据库状态

### 状态值说明

| 状态值 | 说明 | 显示 | 可操作 |
|--------|------|------|--------|
| active | 启用 | ✅ 默认显示 | 编辑、删除 |
| inactive | 停用 | ✅ 默认显示 | 编辑、删除 |
| deleted | 已删除 | ❌ 默认隐藏 | 恢复 |

### 状态转换

```
active ←→ inactive  (正常状态切换)
   ↓         ↓
deleted ←────┘      (软删除)
   ↓
active             (恢复)
```

## 优势与好处

### 1. 数据安全 🔒
- 防止误删除导致数据丢失
- 保留完整的历史记录
- 支持数据审计和追溯

### 2. 用户友好 👥
- 降低操作风险
- 提供后悔机会
- 减少用户焦虑

### 3. 业务灵活 🔄
- 支持临时删除
- 可以批量恢复
- 便于数据迁移

### 4. 合规要求 📋
- 满足数据保留要求
- 支持审计追踪
- 符合法规要求

## 注意事项

### ⚠️ 重要提醒

1. **删除部门的影响**
   - 删除部门会同时删除该部门所有员工
   - 恢复部门会同时恢复所有员工
   - 操作前请确认影响范围

2. **数据库空间**
   - 软删除的数据仍占用数据库空间
   - 建议定期清理长期不用的数据
   - 可以设置自动归档策略

3. **性能考虑**
   - 大量已删除数据可能影响查询性能
   - 建议在查询中添加状态过滤
   - 考虑使用索引优化

4. **权限控制**
   - 恢复操作应该有权限限制
   - 建议只有管理员可以恢复
   - 记录恢复操作日志

### 💡 最佳实践

1. **定期清理**
   - 每季度检查已删除数据
   - 清理超过6个月的已删除数据
   - 保留重要数据的备份

2. **操作记录**
   - 记录删除和恢复操作
   - 包含操作人、时间、原因
   - 便于审计和追溯

3. **用户培训**
   - 告知用户软删除机制
   - 说明恢复方法
   - 强调数据安全性

4. **监控告警**
   - 监控已删除数据量
   - 异常删除操作告警
   - 定期生成报告

## 常见问题

### Q1: 软删除的数据会永久保留吗？

不一定。建议：
- 设置数据保留期限（如6个月）
- 超期自动归档或清理
- 重要数据可以永久保留

### Q2: 如何彻底删除数据？

需要管理员权限：
1. 先软删除数据
2. 等待保留期过后
3. 使用管理工具彻底删除
4. 或者直接在数据库中删除

### Q3: 恢复数据会影响关联数据吗？

会的：
- 恢复部门会恢复所有员工
- 恢复员工不会影响部门
- 建议先恢复父级数据

### Q4: 可以批量恢复吗？

当前版本不支持，后续可以添加：
- 批量选择功能
- 批量恢复按钮
- 批量操作确认

### Q5: 软删除会影响性能吗？

可能会，但可以优化：
- 在状态字段上建立索引
- 定期归档旧数据
- 使用分区表

## 后续优化建议

🔮 **可能的增强功能**：

1. **批量操作**
   - 批量删除
   - 批量恢复
   - 批量归档

2. **自动清理**
   - 设置保留期限
   - 自动归档过期数据
   - 定期清理任务

3. **操作日志**
   - 记录所有删除操作
   - 记录所有恢复操作
   - 支持操作审计

4. **回收站**
   - 专门的回收站页面
   - 统一管理已删除数据
   - 支持搜索和筛选

5. **权限细化**
   - 删除权限
   - 恢复权限
   - 彻底删除权限

---

**更新时间**: 2024-11-09
**版本**: v1.0
**状态**: 已实现
