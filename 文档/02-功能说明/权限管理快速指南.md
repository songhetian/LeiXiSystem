# 🚀 权限管理快速指南

## 一、安装（3分钟）

### 步骤1：执行SQL脚本

```bash
cd customer-service-desktop/database
install-permissions.bat
```

或手动执行：
```bash
mysql -u root -proot leixin_customer_service < permissions-system.sql
```

### 步骤2：重启服务

```bash
# 停止当前服务（Ctrl+C）
npm run dev
```

### 步骤3：验证安装

访问 **系统管理 > 权限管理**，应该看到：
- ✅ 8个系统角色
- ✅ 60+个权限项

---

## 二、基础使用（5分钟）

### 1. 为用户分配角色

```
权限管理 → 用户角色标签 → 管理角色 → 勾选角色 → 自动保存
```

### 2. 创建自定义角色

```
权限管理 → 角色管理标签 → 添加角色 → 填写信息 → 创建
```

### 3. 配置角色权限

```
角色列表 → 权限按钮 → 勾选权限 → 自动保存
```

---

## 三、代码集成（10分钟）

### 前端权限检查

```javascript
import { hasPermission, PERMISSIONS } from '../utils/permission'

// 1. 登录后加载权限
await loadUserPermissions(userId)

// 2. 检查权限
if (hasPermission(PERMISSIONS.EMPLOYEE_CREATE)) {
  // 显示创建按钮
}

// 3. 条件渲染
{hasPermission(PERMISSIONS.EMPLOYEE_UPDATE) && (
  <button>编辑</button>
)}

// 4. 使用权限容器
<PermissionContainer permission={PERMISSIONS.EMPLOYEE_DELETE}>
  <button>删除</button>
</PermissionContainer>
```

### 后端权限保护

```javascript
const { checkPermission } = require('./middleware/permission')

fastify.post('/api/employees', {
  preHandler: [
    verifyToken,
    checkPermission(pool, 'employee:create')
  ]
}, async (request, reply) => {
  // API逻辑
})
```

---

## 四、系统角色说明

| 角色 | 级别 | 适用人员 | 主要权限 |
|-----|------|---------|---------|
| 超级管理员 | 10 | 系统最高管理者 | 所有权限 |
| 系统管理员 | 9 | IT管理员 | 系统管理 |
| 部门经理 | 7 | 部门负责人 | 部门、员工、考勤 |
| 客服主管 | 6 | 客服负责人 | 客服、质检、考核 |
| 培训师 | 5 | 培训人员 | 培训、考核 |
| 质检员 | 4 | 质检人员 | 质检、案例 |
| 客服专员 | 3 | 一线客服 | 基础客服功能 |
| 普通员工 | 1 | 其他员工 | 基础功能 |

---

## 五、常用权限代码

```javascript
// 用户管理
PERMISSIONS.USER_LIST          // 查看用户列表
PERMISSIONS.USER_CREATE        // 创建用户
PERMISSIONS.USER_UPDATE        // 编辑用户
PERMISSIONS.USER_DELETE        // 删除用户

// 员工管理
PERMISSIONS.EMPLOYEE_LIST      // 查看员工列表
PERMISSIONS.EMPLOYEE_CREATE    // 创建员工
PERMISSIONS.EMPLOYEE_UPDATE    // 编辑员工
PERMISSIONS.EMPLOYEE_DELETE    // 删除员工

// 角色管理
PERMISSIONS.ROLE_LIST          // 查看角色列表
PERMISSIONS.ROLE_CREATE        // 创建角色
PERMISSIONS.USER_ASSIGN_ROLE   // 分配角色

// 质检管理
PERMISSIONS.QUALITY_LIST       // 查看质检列表
PERMISSIONS.QUALITY_INSPECT    // 执行质检
PERMISSIONS.QUALITY_STATISTICS // 质检统计
```

---

## 六、常见问题

### Q1: 如何给所有用户分配默认角色？

```sql
INSERT INTO user_roles (user_id, role_id)
SELECT u.id, 8 FROM users u
WHERE NOT EXISTS (
  SELECT 1 FROM user_roles ur WHERE ur.user_id = u.id
);
```

### Q2: 如何查看用户的所有权限？

```javascript
const response = await fetch(`/api/users/${userId}/permissions`)
const permissions = await response.json()
```

### Q3: 系统角色可以删除吗？

不可以。系统角色（is_system=1）不能删除，但可以修改其权限配置。

### Q4: 用户有多个角色时权限如何计算？

用户拥有所有角色的权限并集，即只要任一角色有该权限即可。

---

## 七、API接口速查

```
# 角色管理
GET    /api/roles                              # 获取角色列表
POST   /api/roles                              # 创建角色
PUT    /api/roles/:id                          # 更新角色
DELETE /api/roles/:id                          # 删除角色

# 权限管理
GET    /api/permissions                        # 获取权限列表
GET    /api/roles/:id/permissions              # 获取角色权限
POST   /api/roles/:id/permissions              # 添加角色权限
DELETE /api/roles/:roleId/permissions/:permId  # 移除角色权限

# 用户角色
GET    /api/users-with-roles                   # 获取用户列表（含角色）
GET    /api/users/:id/roles                    # 获取用户角色
POST   /api/users/:id/roles                    # 分配用户角色
DELETE /api/users/:userId/roles/:roleId        # 移除用户角色
GET    /api/users/:id/permissions              # 获取用户权限
GET    /api/users/:id/has-permission/:code     # 检查用户权限
```

---

## 八、最佳实践

### ✅ 推荐做法

1. **最小权限原则** - 只分配必要的权限
2. **定期审计** - 定期检查用户权限
3. **及时回收** - 员工离职及时删除账号
4. **前后端双重检查** - 前端控制显示，后端保证安全
5. **使用权限常量** - 使用 PERMISSIONS 常量而不是硬编码

### ❌ 避免做法

1. ❌ 给所有人分配超级管理员
2. ❌ 只在前端做权限检查
3. ❌ 硬编码权限代码字符串
4. ❌ 删除系统角色
5. ❌ 忘记加载用户权限

---

## 九、文档资源

- 📖 [权限管理系统说明](./docs/权限管理系统说明.md) - 完整系统文档
- 📖 [权限管理使用示例](./docs/权限管理使用示例.md) - 代码示例
- 📖 [权限管理完成说明](./权限管理完成说明.md) - 功能清单

---

## 十、技术支持

遇到问题？

1. 查看文档：`docs/权限管理系统说明.md`
2. 查看示例：`docs/权限管理使用示例.md`
3. 检查日志：查看浏览器控制台和服务器日志
4. 验证数据：检查数据库表是否正确创建

---

**快速开始，立即体验完整的权限管理系统！** 🎉
