# 头像上传功能说明

## 功能概述

员工管理系统现已支持本地文件上传作为员工头像，头像以Base64格式存储在数据库中。

## 功能特点

### 1. 圆形头像显示
- ✅ 表单顶部显示大圆形头像预览（直径96px）
- ✅ 列表中显示小圆形头像（直径40px）
- ✅ 详情页显示中等圆形头像（直径96px）
- ✅ 删除确认框中显示圆形头像

### 2. 本地文件上传
- ✅ 支持选择本地图片文件
- ✅ 自动转换为Base64格式
- ✅ 实时预览上传的图片
- ✅ 支持更换和删除头像

### 3. 文件验证
- ✅ 只允许上传图片格式（JPG、PNG、GIF等）
- ✅ 限制文件大小不超过2MB
- ✅ 上传失败时显示友好提示

### 4. 用户体验
- ✅ 头像位于表单最上方，醒目易见
- ✅ 点击按钮选择文件，操作简单
- ✅ 显示删除按钮（×），方便移除头像
- ✅ 未上传时显示姓名首字母

---

## 界面展示

### 表单中的头像区域
```
┌─────────────────────────────┐
│     ┌───────────────┐       │
│     │   ╭─────╮     │       │
│     │   │ 头像 │  ×  │       │  ← 圆形头像 + 删除按钮
│     │   ╰─────╯     │       │
│     └───────────────┘       │
│     [上传头像/更换头像]      │  ← 上传按钮
│  支持JPG、PNG，不超过2MB    │  ← 提示文字
├─────────────────────────────┤
│  工号: [____]  姓名: [____] │
│  ...其他字段...             │
└─────────────────────────────┘
```

### 列表中的头像显示
```
┌──────────────────────────────┐
│ ╭───╮                        │
│ │头像│ 张三                   │  ← 小圆形头像
│ ╰───╯ E001                   │
└──────────────────────────────┘
```

---

## 技术实现

### 前端实现

#### 1. 状态管理
```javascript
const [avatarPreview, setAvatarPreview] = useState('')
```

#### 2. 文件上传处理
```javascript
const handleAvatarChange = (e) => {
  const file = e.target.files[0]
  if (file) {
    // 验证文件类型
    if (!file.type.startsWith('image/')) {
      toast.error('请选择图片文件')
      return
    }

    // 验证文件大小（限制2MB）
    if (file.size > 2 * 1024 * 1024) {
      toast.error('图片大小不能超过2MB')
      return
    }

    // 读取文件并转换为Base64
    const reader = new FileReader()
    reader.onloadend = () => {
      const base64String = reader.result
      setFormData({ ...formData, avatar: base64String })
      setAvatarPreview(base64String)
    }
    reader.readAsDataURL(file)
  }
}
```

#### 3. 删除头像
```javascript
const handleRemoveAvatar = () => {
  setFormData({ ...formData, avatar: '' })
  setAvatarPreview('')
}
```

#### 4. 头像显示组件
```jsx
<div className="w-24 h-24 rounded-full bg-primary-100 flex items-center justify-center text-3xl font-bold text-primary-600 overflow-hidden border-4 border-white shadow-lg">
  {avatarPreview ? (
    <img src={avatarPreview} alt="头像预览" className="w-full h-full object-cover" />
  ) : (
    <span>{formData.real_name?.charAt(0) || '员'}</span>
  )}
</div>
```

### 后端实现

后端无需修改，直接接收Base64字符串并存储到数据库。

### 数据库修改

#### 修改avatar字段类型
```sql
ALTER TABLE `users`
MODIFY COLUMN `avatar` TEXT DEFAULT NULL COMMENT '头像(Base64或URL)';
```

**原因**：
- VARCHAR(255) 无法存储完整的Base64图片
- TEXT 类型可以存储最多65,535字节
- 足够存储压缩后的头像图片

---

## 使用方法

### 上传头像
1. 打开员工管理页面
2. 点击"添加员工"或"编辑"按钮
3. 在表单顶部看到圆形头像区域
4. 点击"上传头像"按钮
5. 选择本地图片文件（JPG、PNG等）
6. 图片会立即显示在圆形区域中
7. 填写其他信息后保存

### 更换头像
1. 编辑已有员工
2. 点击"更换头像"按钮
3. 选择新的图片文件
4. 保存更改

### 删除头像
1. 编辑员工信息
2. 点击头像右上角的"×"按钮
3. 头像被移除，显示姓名首字母
4. 保存更改

---

## 数据库更新

### 方式一：重新初始化（开发环境）
```bash
cd customer-service-desktop
mysql -u root -p < database/init.sql
```

### 方式二：增量更新（生产环境）
```bash
cd customer-service-desktop
mysql -u root -p < database/update-avatar-field.sql
```

### 方式三：手动执行SQL
```sql
USE leixin_customer_service;
ALTER TABLE `users`
MODIFY COLUMN `avatar` TEXT DEFAULT NULL COMMENT '头像(Base64或URL)';
```

---

## 注意事项

### 1. 文件大小限制
- 限制为2MB，防止数据库过大
- 建议用户上传压缩后的图片
- 如需更大文件，可调整验证逻辑

### 2. Base64存储
- **优点**：
  - 无需额外的文件存储服务
  - 数据库备份包含图片
  - 跨平台兼容性好

- **缺点**：
  - 数据库体积会增大
  - 查询时会传输较大数据

- **建议**：
  - 小团队（<100人）：使用Base64
  - 大团队（>100人）：考虑使用OSS存储

### 3. 性能优化
如果员工数量很多，可以考虑：
- 列表页不加载头像，只在详情页加载
- 使用缩略图（压缩Base64）
- 改用OSS存储，数据库只存URL

### 4. 浏览器兼容性
- FileReader API 支持所有现代浏览器
- IE10+ 支持
- 移动端浏览器完全支持

---

## 样式说明

### 圆形头像CSS
```css
.rounded-full        /* 圆形 */
.overflow-hidden     /* 裁剪溢出 */
.object-cover        /* 图片填充方式 */
.border-4            /* 边框 */
.shadow-lg           /* 阴影 */
```

### 尺寸规范
- 表单预览：96px × 96px
- 列表显示：40px × 40px
- 详情页：96px × 96px
- 删除确认：48px × 48px

---

## 相关文件

### 前端
- `src/components/EmployeeManagement.jsx` - 员工管理组件（已修改）
- `src/components/EmployeeDetail.jsx` - 员工详情组件

### 后端
- `server/index.js` - API接口（无需修改）

### 数据库
- `database/init.sql` - 初始化脚本（已更新）
- `database/update-avatar-field.sql` - 增量更新脚本（新增）

---

## 测试建议

### 测试场景
1. **上传正常图片**
   - 选择JPG/PNG图片
   - 大小在2MB以内
   - ✅ 应该成功上传并显示

2. **上传超大图片**
   - 选择大于2MB的图片
   - ✅ 应该提示"图片大小不能超过2MB"

3. **上传非图片文件**
   - 选择PDF、Word等文件
   - ✅ 应该提示"请选择图片文件"

4. **更换头像**
   - 编辑已有头像的员工
   - 上传新图片
   - ✅ 应该替换原头像

5. **删除头像**
   - 点击×按钮
   - ✅ 头像被移除，显示首字母

6. **保存和显示**
   - 上传头像后保存
   - 刷新页面
   - ✅ 头像应该正确显示

---

**更新时间**：2024-11-09
**版本**：v2.3.0
