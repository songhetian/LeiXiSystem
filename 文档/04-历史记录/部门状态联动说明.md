# 部门状态联动功能说明

## 功能概述

当修改部门状态时，该部门下所有员工的状态将自动同步更新。

## 联动规则

### 规则1：部门启用 → 员工启用
- 当部门状态从"停用"改为"启用"时
- 该部门所有员工的状态自动变为"启用"（active）

### 规则2：部门停用 → 员工停用
- 当部门状态从"启用"改为"停用"时
- 该部门所有员工的状态自动变为"停用"（inactive）

## 操作流程

### 1. 点击状态标签
在部门列表中，点击部门的状态标签（绿色"启用"或灰色"停用"）

### 2. 查看提示信息
弹出的模态框会显示：
- 部门当前状态
- 部门员工数量
- ⚠️ 重要提示：如果部门有员工，会显示黄色警告框
  ```
  该部门有 X 名员工，修改部门状态后，所有员工的状态将同步更新。
  ```

### 3. 选择新状态
点击要设置的状态按钮：
- **启用**：显示"员工状态 → 启用"
- **停用**：显示"员工状态 → 停用"

### 4. 确认操作
如果部门有员工，会弹出二次确认对话框：
```
该部门有 X 名员工，启用/停用部门后，所有员工状态将同步启用/停用。

确定要继续吗？
```

### 5. 执行更新
确认后：
- 更新部门状态
- 同步更新所有员工状态
- 显示成功提示：`部门状态已修改，同时更新了 X 名员工的状态`

## 界面示例

### 状态修改模态框（有员工）

```
┌─────────────────────────────────────┐
│ 修改部门状态                  [×]   │
├─────────────────────────────────────┤
│ ┌─────────────────────────────────┐ │
│ │ 部门名称：客服部                │ │
│ │ 当前状态：[启用]                │ │
│ └─────────────────────────────────┘ │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │ ⚠️ 重要提示                     │ │
│ │ 该部门有 5 名员工，修改部门状态 │ │
│ │ 后，所有员工的状态将同步更新。  │ │
│ └─────────────────────────────────┘ │
│                                     │
│ 选择新状态                          │
│ ┌──────────┐  ┌──────────┐        │
│ │    ✓     │  │    ✕     │        │
│ │  启用    │  │  停用    │        │
│ │部门正常  │  │暂停使用  │        │
│ │员工→启用 │  │员工→停用 │        │
│ └──────────┘  └──────────┘        │
│                                     │
│                          [取消]     │
└─────────────────────────────────────┘
```

### 确认对话框

```
┌─────────────────────────────────────┐
│ 确认                                │
├─────────────────────────────────────┤
│ 该部门有 5 名员工，停用部门后，     │
│ 所有员工状态将同步停用。            │
│                                     │
│ 确定要继续吗？                      │
│                                     │
│              [取消]  [确定]         │
└─────────────────────────────────────┘
```

### 成功提示

```
✅ 部门状态已修改，同时更新了 5 名员工的状态
```

## 技术实现

### 后端逻辑（server/index.js）

```javascript
// 更新部门API
fastify.put('/api/departments/:id', async (request, reply) => {
  // 1. 获取旧的部门状态
  const [oldDept] = await pool.query('SELECT status FROM departments WHERE id = ?', [id])
  const oldStatus = oldDept[0]?.status

  // 2. 更新部门信息
  await pool.query('UPDATE departments SET ... WHERE id = ?', [...])

  // 3. 如果状态发生变化，同步更新员工状态
  if (oldStatus && oldStatus !== status) {
    // 获取该部门的所有员工
    const [employees] = await pool.query(`
      SELECT e.id FROM employees e
      LEFT JOIN users u ON e.user_id = u.id
      WHERE u.department_id = ?
    `, [id])

    // 更新所有员工的状态
    if (employees.length > 0) {
      const employeeStatus = status === 'active' ? 'active' : 'inactive'
      await pool.query(`
        UPDATE employees
        SET status = ?
        WHERE id IN (...)
      `, [employeeStatus, ...])
    }
  }

  // 4. 返回受影响的员工数量
  return {
    success: true,
    affectedEmployees: ...
  }
})
```

### 前端逻辑（DepartmentManagement.jsx）

```javascript
const handleStatusChange = async (newStatus) => {
  // 1. 检查状态是否变化
  if (statusChangingDept.status === newStatus) {
    return // 没有变化，直接返回
  }

  // 2. 如果有员工，显示确认对话框
  const employeeCount = statusChangingDept.employee_count || 0
  if (employeeCount > 0) {
    const confirmMsg = `该部门有 ${employeeCount} 名员工...`
    if (!confirm(confirmMsg)) {
      return // 用户取消
    }
  }

  // 3. 发送更新请求
  const response = await fetch(`/api/departments/${id}`, {
    method: 'PUT',
    body: JSON.stringify({ ...statusChangingDept, status: newStatus })
  })

  // 4. 显示结果
  if (response.ok) {
    const result = await response.json()
    const affectedCount = result.affectedEmployees || 0

    if (affectedCount > 0) {
      toast.success(`部门状态已修改，同时更新了 ${affectedCount} 名员工的状态`)
    } else {
      toast.success('部门状态修改成功')
    }
  }
}
```

## 使用场景

### 场景1：部门重组
**情况**：某部门需要临时停用
**操作**：
1. 点击部门状态标签
2. 选择"停用"
3. 确认操作
4. 部门和所有员工状态同步变为停用

**结果**：
- 部门状态：停用
- 5名员工状态：全部停用
- 系统提示：`部门状态已修改，同时更新了 5 名员工的状态`

### 场景2：部门恢复
**情况**：停用的部门需要重新启用
**操作**：
1. 点击部门状态标签
2. 选择"启用"
3. 确认操作
4. 部门和所有员工状态同步变为启用

**结果**：
- 部门状态：启用
- 5名员工状态：全部启用
- 系统提示：`部门状态已修改，同时更新了 5 名员工的状态`

### 场景3：新建空部门
**情况**：新建的部门还没有员工
**操作**：
1. 修改部门状态
2. 不会显示警告提示
3. 不需要二次确认
4. 直接更新

**结果**：
- 部门状态：已更新
- 系统提示：`部门状态修改成功`

## 注意事项

### ⚠️ 重要提醒

1. **批量影响**
   - 修改部门状态会影响该部门所有员工
   - 操作前请确认影响范围

2. **员工状态**
   - 员工状态会被强制同步
   - 不会保留员工原有的个别状态

3. **二次确认**
   - 有员工的部门会要求二次确认
   - 确保不会误操作

4. **操作记录**
   - 建议在变更记录中记录此类操作
   - 便于后续追溯

### 💡 最佳实践

1. **提前通知**
   - 停用部门前通知相关员工
   - 说明停用原因和影响

2. **分批处理**
   - 如需保留部分员工状态
   - 先将员工转移到其他部门
   - 再停用原部门

3. **定期检查**
   - 定期检查停用部门的状态
   - 及时清理或重新启用

4. **权限控制**
   - 建议只有管理员可以修改部门状态
   - 防止误操作

## 常见问题

### Q1: 如果只想停用部门，不想停用员工怎么办？

**方案1**：先转移员工
1. 将员工转移到其他部门
2. 再停用原部门

**方案2**：手动恢复
1. 停用部门（员工同步停用）
2. 手动将需要的员工改为启用

### Q2: 停用的员工还能登录系统吗？

不能。员工状态为"停用"时：
- 无法登录系统
- 无法执行任何操作
- 需要重新启用才能使用

### Q3: 如何查看哪些员工被影响了？

**方法1**：查看部门详情
1. 点击部门名称
2. 查看职位分布
3. 显示所有员工

**方法2**：查看员工列表
1. 进入员工管理
2. 按部门筛选
3. 查看该部门所有员工

**方法3**：查看变更记录
1. 进入员工变更记录
2. 按时间筛选
3. 查看状态变更记录

### Q4: 可以撤销操作吗？

可以，但需要手动操作：
1. 将部门状态改回原状态
2. 所有员工状态会再次同步
3. 或者手动修改个别员工状态

### Q5: 会影响员工的历史数据吗？

不会。只影响当前状态：
- 员工的历史记录保持不变
- 工作记录不受影响
- 只是当前状态被更新

## 后续优化建议

🔮 **可能的增强功能**：

1. **选择性同步**
   - 提供选项：是否同步员工状态
   - 允许保留部分员工的状态

2. **批量恢复**
   - 记录变更前的员工状态
   - 提供一键恢复功能

3. **变更日志**
   - 自动记录到变更记录表
   - 包含变更原因和影响范围

4. **通知功能**
   - 状态变更时通知相关员工
   - 发送邮件或系统通知

5. **权限细化**
   - 区分部门编辑和状态修改权限
   - 状态修改需要更高权限

---

**更新时间**: 2024-11-09
**版本**: v1.0
**状态**: 已实现
